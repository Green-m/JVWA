package com.ffffffff0x.exploit;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.net.MalformedURLException;
import java.net.URL;

@RestController
public class Redirect {

    // 无过滤
    @RequestMapping("/redirect/1")
    public String vul(String url) {
        return "redirect:" + url;
    }

    // 黑名单过滤
    @RequestMapping("/redirect/2")
    public String vul2(String url) {
        String host = url.replace("://", "");
        return "redirect:" + host;
    }

    // 可以被绕过的白名单案例
    @RequestMapping("/redirect/3")
    public String vul3(String url) {
        String domain = "ffffffff0x.com";
        int result = url.indexOf(domain);
        if(result != -1){
            return "redirect:" + url;
        }else{
            System.out.println("");
            return "block";
        }
    }

    // 反斜杠绕过
    // ?url=http://www.eval.com%5Cwww.ffffffff0x.com
    @RequestMapping("/redirect/4")
    public String vul4(String url) {

        String host = "";
        try {
            host = new URL(url).getHost();
        } catch (MalformedURLException e) {
            e.printStackTrace();
        }
        if (host.endsWith(".ffffffff0x.com")){
            return "redirect:" + host;
        }else{
            return "block";
        }
    }

    // 安全案例
    @RequestMapping("/redirect/5")
    public String vul5(String url) {

        String host = "";
        try {
            url = url.replaceAll("[\\\\#]","/");
            host = new URL(url).getHost();
        } catch (MalformedURLException e) {
            e.printStackTrace();
        }
        if (host.endsWith(".ffffffff0x.com")){
            return "redirect:" + host;
        }else{
            return "block";
        }
    }

}
