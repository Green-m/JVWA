package com.ffffffff0x.exploit;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.net.MalformedURLException;
import java.net.URL;

//@RestController
@Controller
public class Redirect {

    // 无过滤
    // http://127.0.0.1:8777/redirect/1?url=https://baidu.com
    @RequestMapping("/redirect/1")
    public String vul(String url) {
        return"redirect:" + url;
    }

    // 可以被绕过的白名单案例
    // http://127.0.0.1:8777/redirect/2?url=http://baidu.com/ffffffff0x.com
    @RequestMapping("/redirect/2")
    public String vul2(String url) {
        String domain = "ffffffff0x.com";
        int result = url.indexOf(domain);
        if(result != -1){
            return"redirect:" + url;
        }else{
            System.out.println("");
            return"redirect:/error";
        }
    }

    // 反斜杠绕过
    // http://127.0.0.1:8777/redirect/3?url=http://www.baidu.com%5Cwww.ffffffff0x.com
    @RequestMapping("/redirect/3")
    public String vul3(String url) {

        String host = "";
        try {
            host = new URL(url).getHost();
        } catch (MalformedURLException e) {
            e.printStackTrace();
        }
        if (host.endsWith(".ffffffff0x.com")){
            return"redirect:https://" + host;
        }else{
            return"redirect:/error";
        }
    }

    // 安全案例
    // http://127.0.0.1:8777/redirect/safe?url=https://home.ffffffff0x.com
    @RequestMapping("/redirect/safe")
    public String safe(String url) {

        String host = "";
        try {
            url = url.replaceAll("[\\\\#]","/");
            host = new URL(url).getHost();
        } catch (MalformedURLException e) {
            e.printStackTrace();
        }
        if (host.endsWith(".ffffffff0x.com")){
            return"redirect:https://" + host;
        }else{
            return"redirect:/error";
        }
    }

}
